# Интеграция ikap с Cloud Run OCR сервисом

## Шаг 1: Настройка переменных окружения в ikap

В проекте `ikap` нужно настроить переменные окружения для использования Cloud Run OCR сервиса.

### Для локальной разработки:

Создай файл `.env` в корне проекта `ikap` (или добавь в существующий):

```bash
# URL Cloud Run OCR сервиса
PDF_SERVICE_URL=https://pdf-ocr-469114228.europe-west1.run.app

# Включить использование HTTP сервиса (вместо локального Python)
USE_PDF_SERVICE_HTTP=true
```

### Для production (Render.com или другой хостинг):

Добавь эти переменные окружения в настройках сервиса:

- `PDF_SERVICE_URL` = `https://pdf-ocr-469114228.europe-west1.run.app`
- `USE_PDF_SERVICE_HTTP` = `true`

## Шаг 2: Проверка работы

После настройки переменных окружения:

1. Перезапусти сервер `ikap` (если он запущен локально)
2. Загрузи PDF файл через интерфейс `ikap`
3. Сервис должен автоматически использовать Cloud Run OCR вместо локального Python скрипта

## Шаг 3: Проверка логов

Если что-то не работает, проверь логи:

- В `ikap` ищи сообщения типа: `❌ Ошибка HTTP запроса к PDF-сервису`
- В Cloud Run Console проверь логи сервиса `pdf-ocr`

## Формат запроса

`ikap` отправляет POST запрос на `/process` с FormData:
- Поле: `files` (или `file`)
- Content-Type: `multipart/form-data`

Cloud Run сервис возвращает JSON напрямую (не файл для скачивания).

## Troubleshooting

### Ошибка: "Не удалось конвертировать PDF через HTTP"

1. Проверь, что `PDF_SERVICE_URL` правильный
2. Проверь, что `USE_PDF_SERVICE_HTTP=true`
3. Проверь, что Cloud Run сервис доступен: открой `https://pdf-ocr-469114228.europe-west1.run.app/health` в браузере

### Ошибка: Timeout

Cloud Run может занять 1-2 минуты на первую инициализацию EasyOCR. Убедись, что timeout в `pdfConverter.js` достаточный (сейчас 300 секунд = 5 минут).

### Ошибка: Формат ответа не совместим

Если формат JSON от Cloud Run не совместим с ожидаемым в `ikap`, нужно будет адаптировать формат. Сейчас Cloud Run возвращает:
```json
{
  "metadata": {...},
  "pages": [...]
}
```

А `ikap` ожидает:
```json
[
  {
    "source_file": "...",
    "metadata": {...},
    "transactions": [...]
  }
]
```

Если нужна адаптация формата, дай знать - добавим преобразование в Cloud Run сервисе.

